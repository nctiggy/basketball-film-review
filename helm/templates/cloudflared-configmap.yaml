{{- if .Values.cloudflared.enabled -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.app.name }}-cloudflared-config
  labels:
    app: {{ .Values.app.name }}
    component: cloudflared
data:
  config.yaml: |
    tunnel: {{ .Values.cloudflared.tunnelId }}
    credentials-file: /etc/cloudflared/creds/credentials.json
    metrics: 0.0.0.0:2000
    no-autoupdate: true

    ingress:
      # Route traffic to the frontend service
      - hostname: {{ .Values.cloudflared.hostname }}
        service: http://{{ .Values.app.name }}-frontend:{{ .Values.frontend.service.port }}
        originRequest:
          noTLSVerify: true

      # Catch-all rule (required)
      - service: http_status:404
{{- end }}
